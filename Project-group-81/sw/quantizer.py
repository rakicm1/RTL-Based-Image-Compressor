#
# Comp Eng 3DQ5 - Digital Systems Design - Fall 2025
# Department of Electrical and Computer Engineering
# McMaster University, Ontario, Canada
#
# This file is part of the copyrighted software model distribution for the
# course project on the hardware implementation of the .mic19 decompressor.
#
import numpy as np

class Quantizer:

	quant_matrix_luma_0 = np.array([
		[16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16],
		[16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16],
		[16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16],
		[16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16],
		[16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 32],
		[16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 32, 32],
		[16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 32, 32, 32],
		[16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 32, 32, 32, 32],
		[16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 32, 32, 32, 32, 32],
		[16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 32, 32, 32, 32, 32, 32],
		[16, 16, 16, 16, 16, 16, 16, 16, 16, 32, 32, 32, 32, 32, 32, 32],
		[16, 16, 16, 16, 16, 16, 16, 16, 32, 32, 32, 32, 32, 32, 32, 32],
		[16, 16, 16, 16, 16, 16, 16, 32, 32, 32, 32, 32, 32, 32, 32, 32],
		[16, 16, 16, 16, 16, 16, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
		[16, 16, 16, 16, 16, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
		[16, 16, 16, 16, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32]
	], dtype=np.uint8)

	quant_matrix_chroma_0 = np.array([
		[8, 8, 8, 8, 8, 8, 8, 16],
		[8, 8, 8, 8, 8, 8, 16, 16],
		[8, 8, 8, 8, 8, 16, 16, 16],
		[8, 8, 8, 8, 16, 16, 16, 16],
		[8, 8, 8, 16, 16, 16, 16, 32],
		[8, 8, 16, 16, 16, 16, 32, 32],
		[8, 16, 16, 16, 16, 32, 32, 32],
		[16, 16, 16, 16, 32, 32, 32, 32]
	], dtype=np.uint8)

	quant_matrix_luma_1 = np.array([
		[16, 16, 16, 16, 16, 16, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
		[16, 16, 16, 16, 16, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
		[16, 16, 16, 16, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
		[16, 16, 16, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
		[16, 16, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
		[16, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
		[32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 64],
		[32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 64, 64],
		[32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 64, 64, 64],
		[32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 64, 64, 64, 64],
		[32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 64, 64, 64, 64, 64],
		[32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 64, 64, 64, 64, 64, 64],
		[32, 32, 32, 32, 32, 32, 32, 32, 32, 64, 64, 64, 64, 64, 64, 64],
		[32, 32, 32, 32, 32, 32, 32, 32, 64, 64, 64, 64, 64, 64, 64, 64],
		[32, 32, 32, 32, 32, 32, 32, 64, 64, 64, 64, 64, 64, 64, 64, 64],
		[32, 32, 32, 32, 32, 32, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64]
	], dtype=np.uint8)

	quant_matrix_chroma_1 = np.array([
		[8, 8, 8, 16, 16, 16, 16, 32],
		[8, 8, 16, 16, 16, 16, 32, 32],
		[8, 16, 16, 16, 16, 32, 32, 32],
		[16, 16, 16, 16, 32, 32, 32, 32],
		[16, 16, 16, 32, 32, 32, 32, 32],
		[16, 16, 32, 32, 32, 32, 32, 64],
		[16, 32, 32, 32, 32, 32, 64, 64],
		[32, 32, 32, 32, 32, 64, 64, 64]
	], dtype=np.uint8)

	def __init__(self, index=0):
		self.quant_matrix_luma = Quantizer.quant_matrix_luma_0 if index==0 else Quantizer.quant_matrix_luma_1
		self.quant_matrix_chroma = Quantizer.quant_matrix_chroma_0 if index==0 else Quantizer.quant_matrix_chroma_1

	def quantize(self, block, luma=False):
		q = self.quant_matrix_luma if luma else self.quant_matrix_chroma
		rounded = (block + (q // 2)) // q
		clipped = np.clip(rounded, -256, 255)
		return clipped.astype(np.int16)

	def requantize(self, block, luma=False):
		q = self.quant_matrix_luma if luma else self.quant_matrix_chroma
		return (block * q).astype(np.int32)
